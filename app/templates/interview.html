<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mock Interview - {{ role }} @ {{ company }}</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
body {margin:0;font-family:'Roboto',sans-serif;background:url('{{ bg_url }}') no-repeat center center fixed;background-size:cover;color:#333;}
.overlay{backdrop-filter:blur(8px);background:rgba(255,255,255,0.85);min-height:100vh;display:flex;flex-direction:column;padding-bottom:40px;animation:fadeInBg 1.5s ease;}
@keyframes fadeInBg{from{opacity:0;}to{opacity:1;}}
.navbar{background:linear-gradient(90deg,#4a6cf7,#2ecc71);padding:15px 30px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,0.2);color:#fff;}
.navbar h1{font-size:20px;margin:0;}
.btn-home{background:white;color:#4a6cf7;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;text-decoration:none;font-weight:500;transition:all 0.3s ease;}
.btn-home:hover{background:#f2f2f2;}
.progress-container{width:100%;background:#eee;height:6px;margin-top:5px;}
.progress-bar{height:6px;width:0%;background:linear-gradient(90deg,#3498db,#2ecc71);transition:width 0.5s ease;}
.dashboard{display:flex;justify-content:center;flex:1;align-items:center;padding:40px 20px;}
.card{background:white;border-radius:15px;padding:40px 30px;box-shadow:0 8px 20px rgba(0,0,0,0.15);max-width:650px;width:100%;text-align:center;animation:fadeInCard 1s ease;}
@keyframes fadeInCard{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.card:hover{box-shadow:0 12px 28px rgba(0,0,0,0.2);transition:0.3s;}
.card h2{margin-top:0;font-size:22px;margin-bottom:20px;font-weight:500;}
.rules-box{background:#fff3cd;color:#856404;padding:12px 15px;margin-bottom:20px;border-left:5px solid #ffeeba;border-radius:8px;font-size:14px;line-height:1.4;text-align:left;}
.question-box{margin-bottom:20px;background:#e6f0ff;color:#1c3d72;padding:18px 22px;border-radius:10px;font-size:17px;line-height:1.4;min-height:60px;display:flex;align-items:center;justify-content:center;animation:fadeInQuestion 0.8s ease;}
@keyframes fadeInQuestion{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}
.answer-box{width:100%;padding:12px 14px;font-size:16px;border-radius:8px;border:1px solid #ccc;margin-bottom:18px;outline:none;transition:all 0.3s ease;}
.answer-box:focus{border-color:#4a6cf7;box-shadow:0 0 5px rgba(74,108,247,0.3);}
.btn-submit{background:linear-gradient(45deg,#3498db,#2ecc71);color:white;border:none;padding:14px 28px;font-size:16px;border-radius:30px;cursor:pointer;margin-top:15px;transition:0.3s ease;}
.btn-submit:hover{transform:scale(1.05);box-shadow:0 6px 16px rgba(0,0,0,0.15);}
</style>
</head>
<body>
<div class="overlay">
<div class="navbar">
<h1>Mock Interview: {{ role }} @ {{ company }}</h1>
<a href="{{ url_for('home') }}" class="btn-home">Back to Homepage</a>
</div>

<div class="progress-container">
  <div id="progress-bar" class="progress-bar"></div>
</div>

<div class="dashboard">
  <div class="card">
    <!-- üîî Rules / Tips Box -->
    <div class="rules-box">
      <strong>üéØ Tips for Speaking:</strong>
      <ul style="margin:5px 0 0 15px; padding:0;">
        <li>Speak loud and clear in one go; multiple starts may reset the recording.</li>
        <li>Some words may not be captured correctly‚Äîyou can edit them manually afterward.</li>
        <li>Use US English accent for better recognition.</li>
        <li>Try to speak complete answers without long pauses.</li>
      </ul>
    </div>

    <h2 id="question-title">Answer the following question:</h2>
    <div id="question-container" class="question-box"></div>

    <input type="text" id="answer" class="answer-box" placeholder="Type your answer here..." />

    <!-- üé§ Mic button -->
    <div style="margin: 10px 0;">
      <button id="mic-btn" type="button" class="btn-submit" style="background:#e74c3c;">
        üé§ Speak Answer
      </button>
    </div>

    <button id="next-btn" class="btn-submit">Submit & Next</button>

    <!-- Hidden form to submit answers -->
    <form id="result-form" action="{{ url_for('submit_interview') }}" method="POST" style="display:none;">
      <input type="hidden" name="company" value="{{ company }}">
      <input type="hidden" name="role" value="{{ role }}">
    </form>
  </div>
</div>
</div>

<script>
const questions = {{ questions | tojson }};
const questionTexts = questions.map(q => typeof q === "string" ? q : q.q);
let currentIndex = 0;
const userAnswers = [];

const questionContainer = document.getElementById('question-container');
const answerInput = document.getElementById('answer');
const nextBtn = document.getElementById('next-btn');
const progressBar = document.getElementById('progress-bar');
const resultForm = document.getElementById('result-form');
const micBtn = document.getElementById("mic-btn");

function updateProgress() {
  const progress = (currentIndex / questionTexts.length) * 100;
  progressBar.style.width = progress + "%";
}

function showQuestion(index) {
  if(index < questionTexts.length){
    questionContainer.textContent = "Q"+(index+1)+". "+questionTexts[index];
    answerInput.value = "";
    answerInput.style.display = "block";
    nextBtn.style.display = "inline-block";
    micBtn.style.display = "inline-block";
    answerInput.focus();
    updateProgress();
  } else {
    document.getElementById("question-title").textContent = "üéâ You‚Äôve completed the mock interview!";
    questionContainer.textContent = "Click below to view your results.";
    answerInput.style.display = "none";
    nextBtn.style.display = "none";
    micBtn.style.display = "none";
    progressBar.style.width = "100%";

    const viewBtn = document.createElement("button");
    viewBtn.textContent = "View Your Results";
    viewBtn.className = "btn-submit";
    viewBtn.onclick = function(){
      userAnswers.forEach(ans=>{
        const input = document.createElement("input");
        input.type="hidden";
        input.name="answers";
        input.value=ans;
        resultForm.appendChild(input);
      });
      resultForm.submit();
    };
    document.querySelector(".card").appendChild(viewBtn);
  }
}

nextBtn.addEventListener('click', ()=>{
  const userAnswer = answerInput.value.trim();
  if(!userAnswer){
    alert("‚ö†Ô∏è Answer cannot be empty!");
    return;
  }
  userAnswers.push(userAnswer);
  currentIndex++;
  showQuestion(currentIndex);
});

showQuestion(currentIndex);

// üé§ Speech-to-Text functionality
let mediaRecorder;
let audioChunks = [];

micBtn.addEventListener("click", async () => {
  if (!mediaRecorder || mediaRecorder.state === "inactive") {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", audioBlob);

        try {
          const response = await fetch("/transcribe", { method: "POST", body: formData });
          const data = await response.json();
          if (data.text) {
            answerInput.value = data.text;
          } else {
            alert("‚ùå Could not transcribe speech.");
          }
        } catch(err) {
          console.error(err);
          alert("‚ùå Error communicating with server.");
        }
      };

      mediaRecorder.start();
      micBtn.textContent = "‚èπ Stop Recording";
      micBtn.style.background = "#2ecc71";
      questionContainer.textContent = "üéô Recording... speak now!";
    } catch(err) {
      alert("‚ö†Ô∏è Microphone access denied or not available: " + err.message);
    }

  } else {
    mediaRecorder.stop();
    micBtn.textContent = "üé§ Speak Answer";
    micBtn.style.background = "#e74c3c";
    questionContainer.textContent = questionTexts[currentIndex];
  }
});
</script>
</body>
</html>
